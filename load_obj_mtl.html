<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>省分大楼</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      /* 隐藏body窗口区域滚动条 */
    }

    .label {
      width: 100px;
      height: 50px;
      color: #FFF;
      font-family: sans-serif;
      padding: 2px;
      background: rgb(87, 179, 248);
      opacity: .7;
      text-align: center;
      cursor: pointer;
      position: absolute;
      top: 500px;
      line-height: 50px;
    }

    .moveDiv {
      width: 150px;
      height: 100px;
      color: #FFF;
      background: rgb(87, 179, 248, .6);
      text-align: center;
      position: absolute;
      top: 300px;
      line-height: 100px;
      cursor: pointer;
    }

    #bianjie {
      position: absolute;
      top: 0;
      left: 30%;
      width: 100px;
      height: 20px;
      color: #fff;

    }

    .testDiv {
      position: absolute;
      padding: 10px;
      background: rgba(255, 255, 255, 0.6);
      line-height: 1;
      border-radius: 5px;
    }
  </style>
  <script src="https://cdn.staticfile.org/jquery/3.5.0/jquery.min.js"></script>
  <!--引入three.js三维引擎-->
  <script src="./js/three.js"></script>
  <!-- 引入threejs扩展控件OrbitControls.js -->
  <script src="./js/OrbitControls.js"></script>
  <!-- 引入gltf -->
  <script src="./js/GLTFLoader.js"></script>
  <!-- fps查看 -->
  <script src="./js/stats.min.js"></script>
  <!--加载控制器-->
  <script src="./js/TrackballControls.js"></script>
  <!-- 2D渲染器 -->
  <script src="./js/CSS2DRenderer.js"></script>
  <!--加载缓动插件-->
  <script src="./js/TweenMax.min.js"></script>
</head>

<body>
  <div class="moveDiv" value="play()">点击移动</div>
  <!-- <div id="bianjie">便捷通行</div> -->
  <div class="testDiv"></div>
  <canvas id="cc"></canvas>
  <script>
    let mixer = null;
    let objAll = null;
    let container, stats, controls;

    let camera, scene, renderer, light, point, directionalLight, ambient;

    let model;

    let Vplace1 = [];
    let Vplace2 = [];
    let width, height, k, s;

    let GLTFLoader_AllBuild, GLTFLoader_First, GLTFLoader_Video2, GLTFLoader_Video3, GLTFLoader_Video4;

    let model_floor1, model_floor2, model_floor3, model_floor4, model_floor5;
    let model_video1, model_video2, model_video3, model_video4, model_video5;

    // let video_path1 = './assets/sexiangtou1.gltf'
    // let video_path2 = './assets/sexiangtou2.gltf'
    // let video_path3 = './assets/sexiangtou3.gltf'
    // let video_path4 = './assets/sexiangtou4.gltf'

    let video_path = './assets/sexiangtou.gltf'

    let model_all = [] //所有模型
    let model_all_floor1 = [] //每层所有模型
    let model_all_floor2 = []
    let model_all_floor3 = []
    let model_all_floor4 = []
    let model_all_floor5 = []
    let model_all_floor6 = []
    let model_all_floor7 = []
    let model_all_floor8 = []
    let model_all_floor9 = []
    let model_all_floorB1 = []
    //创建控件对象  相机对象camera作为参数   控件可以监听鼠标的变化，改变相机对象的属性
    // controls = new THREE.OrbitControls(camera, renderer.domElement);

    init();
    initStats();
    animate();

    function initStats() {
      stats = new Stats();
      document.body.appendChild(stats.dom);
    }

    function init() {
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        canvas: document.querySelector("#cc")
      });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true; //渲染器接收阴影渲染

      window.addEventListener('resize', onWindowResize, false); //窗口大小变化后，针对当前窗口大小比例渲染

      /**
       * 相机设置
       */
      width = window.innerWidth; //窗口宽度
      height = window.innerHeight; //窗口高度
      k = width / height; //窗口宽
      // s = 300; //三维场景显示范围控制系数，系数越大，显示的范围越大
      s = 250;
      //创建相机对象
      camera = new THREE.OrthographicCamera(-s * k, s * k, s, -s, 1, 20000);
      camera.position.set(300, 100, -150); //设置相机位置
      // camera.position.set(1000, 1000, 2000); //设置相机位置
      // camera.position.z = 2000

      // //监听鼠标事件，触发渲染函数，更新canvas画布渲染效果
      controls = new THREE.OrbitControls(camera, document.querySelector("#cc")); //添加控制器 //设置控制器。方便操控3d世界。
      // controls.target.set(0, 0, 0); //设置控制器控制中心点
      // controls.update(); //控制器更新

      scene = new THREE.Scene(); //创建场景
      scene.name = 'WEB_Scene'
      // camera.lookAt(scene.position); //设置相机方向(指向的场景对象)
      /**
       * 光源设置
       */
      //点光源
      point = new THREE.PointLight(0x72b1ff);
      point.position.set(1270.480, 172.285, 103.841); //点光源中间门上
      scene.add(point); //点光源添加到场景中
      // var point2 = new THREE.PointLight(0x72b1ff);
      // point2.position.set(-554.418, 337.135, -20.433); //点光源左侧
      // scene.add(point2); //点光源添加到场景中
      // var point3 = new THREE.PointLight(0x72b1ff);
      // point3.position.set(863.018, 478.976, -21.585); //点光源右侧
      // scene.add(point3); //点光源添加到场景中
      // var point4 = new THREE.PointLight(0x72b1ff);
      // point4.position.set(136.340, 336.995, -438.744); //点光源后侧
      // scene.add(point4); //点光源添加到场景中
      // var point5 = new THREE.PointLight(0x72b1ff);
      // point5.position.set(-52.809, 385.392, 610.896); //左圈
      // scene.add(point5); //点光源添加到场景中

      //平行光
      directionalLight = new THREE.DirectionalLight(0xffffff, 0.3);
      scene.add(directionalLight);
      //环境光
      ambient = new THREE.AmbientLight(0x72b1ff);
      scene.add(ambient);

      //非交互模型加载
      // GLTFLoader_AllBuild = new THREE.GLTFLoader();
      // GLTFLoader_AllBuild.load('./assets/index.gltf', function (obj) { //道路及大楼
      //   objAll = obj
      //   obj.scene.name = "all"
      //   scene.add(obj.scene)
      // })

      GLTFLoader_First = new THREE.GLTFLoader();
      GLTFLoader_First.load('./assets/1floor.gltf', function (obj) { //第一层楼
        model_floor1 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "1floor"
      })

      GLTFLoader_Video2 = new THREE.GLTFLoader();
      GLTFLoader_Video2.load('./assets/2floor.gltf', function (obj) {
        model_floor2 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "2floor"
      })

      GLTFLoader_Video3 = new THREE.GLTFLoader();
      GLTFLoader_Video3.load('./assets/3floor.gltf', function (obj) {
        model_floor3 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "3floor"
      })

      GLTFLoader_Video4 = new THREE.GLTFLoader();
      GLTFLoader_Video4.load('./assets/4floor.gltf', function (obj) {
        model_floor4 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "4floor"
      })

      GLTFLoader_Video5 = new THREE.GLTFLoader();
      GLTFLoader_Video5.load('./assets/5floor.gltf', function (obj) {
        model_floor5 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "5floor"
      })

      GLTFLoader_Video6 = new THREE.GLTFLoader();
      GLTFLoader_Video6.load('./assets/6floor.gltf', function (obj) {
        model_floor6 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "6floor"
      })

      GLTFLoader_Video7 = new THREE.GLTFLoader();
      GLTFLoader_Video7.load('./assets/7floor.gltf', function (obj) {
        model_floor7 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "7floor"
      })

      GLTFLoader_Video8 = new THREE.GLTFLoader();
      GLTFLoader_Video8.load('./assets/8floor.gltf', function (obj) {
        model_floor8 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "8floor"
      })

      GLTFLoader_Video9 = new THREE.GLTFLoader();
      GLTFLoader_Video9.load('./assets/9floor.gltf', function (obj) {
        model_floor9 = obj.scene
        scene.add(obj.scene)
        obj.scene.name = "9floor"
      })

      // GLTFLoader_VideoB1 = new THREE.GLTFLoader();
      // GLTFLoader_VideoB1.load('./assets/b1.gltf', function (obj) {
      //   model_floorB1 = obj.scene
      //   scene.add(obj.scene)
      //   obj.scene.name = "B1floor"
      // })

      loadModel(video_path, 'video1', 3, 50.132, 30.287, 195.904)
      loadModel(video_path, 'video2', 3, 47.173, 30.287, 171.65)
      loadModel(video_path, 'video3', 3, -0.72, 2.4, -6.34)
      loadModel(video_path, 'video4', 3, -5.72, 2.4, -6.34)

      // var labelRenderer = new THREE.CSS2DRenderer();
      // labelRenderer.setSize(window.innerWidth, window.innerHeight);
      // labelRenderer.domElement.style.position = 'absolute';
      // labelRenderer.domElement.style.top = 0;
      // labelRenderer.render( scene, camera );
    }


    // 点击隐藏
    var moonDiv = document.createElement('div');
    moonDiv.className = 'label';
    moonDiv.textContent = '点击折叠';
    let bodyDom = document.body;
    bodyDom.insertBefore(moonDiv, bodyDom.lastChild);


    let model_all_num = {}
    model_all_num['model_all_floor' + 1] = []
    model_all_num['model_all_floor' + 2] = []
    model_all_num['model_all_floor' + 3] = []
    model_all_num['model_all_floor' + 4] = []
    model_all_num['model_all_floor' + 5] = []
    model_all_num['model_all_floor' + 6] = []
    model_all_num['model_all_floor' + 7] = []
    model_all_num['model_all_floor' + 8] = []
    model_all_num['model_all_floor' + 9] = []


    let tween1, tween2, tween3, tween4, tween5, tween6, tween7, tween8, tween9, tween10;

    $('.label').on('click', function () {
      if (model_floor1.position.y != -120) {
        return
      } else {
        tween1.reversed(!tween1.reversed())
        tween2.reversed(!tween2.reversed())
        tween3.reversed(!tween3.reversed())
        tween4.reversed(!tween4.reversed())
        tween5.reversed(!tween5.reversed())
        tween6.reversed(!tween6.reversed())
        tween7.reversed(!tween7.reversed())
        tween8.reversed(!tween8.reversed())
        tween9.reversed(!tween9.reversed())
        // tween10.reversed(!tween10.reversed())
      }

    })
    //点击移动
    $('.moveDiv').on('click', function () {
      console.log(model_floor1.position.y)
      removeEntity('all')
      if (model_floor1.position.y != 0) {
        return
      } else {
        //获取摄像头模型
        // model_video1 = scene.getObjectByName('video1')
        // model_video2 = scene.getObjectByName('video2')
        // model_video3 = scene.getObjectByName('video3')
        // model_video4 = scene.getObjectByName('video4')

        //增加每层模型
        model_all_num['model_all_floor' + 1].push(model_floor1.position)
        model_all_num['model_all_floor' + 2].push(model_floor2.position)
        model_all_num['model_all_floor' + 3].push(model_floor3.position)
        model_all_num['model_all_floor' + 4].push(model_floor4.position)
        model_all_num['model_all_floor' + 5].push(model_floor5.position)
        model_all_num['model_all_floor' + 6].push(model_floor6.position)
        model_all_num['model_all_floor' + 7].push(model_floor7.position)
        model_all_num['model_all_floor' + 8].push(model_floor8.position)
        model_all_num['model_all_floor' + 9].push(model_floor9.position)

        // model_all_floorB1.push(model_floorB1.position)

        tween1 = TweenMax.to(model_all_num['model_all_floor' + 1], 2, {
          y: -120,
          ease: Power3.easeOut //Linear.easeNone
        });
        tween2 = TweenMax.to(model_all_num['model_all_floor' + 2], 2, {
          y: -90,
          ease: Power3.easeOut
        });
        tween3 = TweenMax.to(model_all_num['model_all_floor' + 3], 2, {
          y: -60,
          ease: Power3.easeOut
        });
        tween4 = TweenMax.to(model_all_num['model_all_floor' + 4], 2, {
          y: -30,
          ease: Power3.easeOut
        });
        tween5 = TweenMax.to(model_all_num['model_all_floor' + 5], 2, {
          y: 0,
          ease: Power3.easeOut
        });
        tween6 = TweenMax.to(model_all_num['model_all_floor' + 6], 2, {
          y: 30,
          ease: Power3.easeOut
        });
        tween7 = TweenMax.to(model_all_num['model_all_floor' + 7], 2, {
          y: 60,
          ease: Power3.easeOut
        });
        tween8 = TweenMax.to(model_all_num['model_all_floor' + 8], 2, {
          y: 90,
          ease: Power3.easeOut
        });
        tween9 = TweenMax.to(model_all_num['model_all_floor' + 9], 2, {
          y: 120,
          ease: Power3.easeOut
        });
        // tween10 = TweenMax.to(model_all_floorB1, 2, {
        //   y: -1000,
        //   ease: Power3.easeOut
        // });
        // modelTraverse()
        // removeEntity(objAll)
        // moveFloor()
        tween1.play()
        tween2.play()
        tween3.play()
        tween4.play()
        tween5.play()
        tween6.play()
        tween7.play()
        tween8.play()
        tween9.play()
        // tween10.play()
      }

      // let component = model_floor1.getObjectByName('1floor')
    })

    var test = 'model_video'
    let model_position

    //隐藏模型 
    function removeEntity(object) {
      var selectedObject = scene.getObjectByName(object);
      scene.remove(selectedObject);
    }

    //遍历所有模型
    function modelTraverse() {
      for (let i = 0; i < scene.children.length; i++) {
        model_all.push(scene.children[i])
      }
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight; //相机视锥体的长宽比
      camera.updateProjectionMatrix(); //更新相机投影矩阵

      renderer.setSize(window.innerWidth, window.innerHeight); //渲染器大小
    }

    // 更新div的位置
    function renderDiv(object) {
      // let object_position = object.localToWorld()
      // console.log(object_position)
      var vector = new THREE.Vector3();
      // 获取窗口的一半高度和宽度
      let halfWidth = window.innerWidth / 2;
      let halfHeight = window.innerHeight / 2;
      console.log(halfWidth)
      console.log(halfHeight)

      object.updateMatrixWorld();//更新下对象的世界坐标/世界矩阵

      // 逆转相机求出二维坐标
      // let vector1 = object.position.clone().project(camera);

      vector.setFromMatrixPosition(object.matrixWorld);
      vector.project(camera);
      console.log(vector)
      // console.log((vector.x * halfWidth) + halfWidth)
      // 修改 div 的位置
      $(".testDiv").css({
        left: (vector.x * halfWidth) + halfWidth,// - object.position.x,
        top: -(vector.y * halfHeight) + halfHeight
      });
      // 显示模型信息
      $(".testDiv").text("name:" + object.name);
    }

    function animate() {
      stats.update();
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }


    function loadModel(path, gltf_name, floor_num, pst_x, pst_y, pst_z) {
      new THREE.GLTFLoader().load(path, function (gltf) {
        gltf.scene.name = gltf_name //set模型名字
        gltf.scene.position.set(pst_x, pst_y, pst_z);//set模型位置

        model_all_num['model_all_floor' + floor_num].push(gltf.scene.position)//添加模型所在楼层位置

        console.log(model_all_num['model_all_floor' + floor_num])
        // model.position.set(0, 60, 0);
        let sc = 2;
        model = gltf.scene.children[0];
        model.traverse(function (child) {
          //对模型体内的每个几何体进行遍历
          if (child.isMesh) {
            child.castShadow = true; //允许模型本身对自己产生阴影
            child.receiveShadow = true; //接受阴影渲染
            child.scale.set(sc, sc, sc); //模型重置比例放大。

            Vplace1.push(child);
          }
        });

        scene.add(gltf.scene);
        // animate();
      });
    }

    document.addEventListener('click', function () {
      ray(Vplace1)
    }, false);

    function getGroup(groupName, mesh) {
      let { parent } = mesh;
      while (parent) {
        if (parent.isGroup && parent.name === groupName) {
          return parent;
        }

        parent = parent.parent;
      }
    }

    function ray(Bplace) {
      // var Sx = event.clientX; //鼠标单击位置横坐标
      // var Sy = event.clientY; //鼠标单击位置纵坐标

      // //屏幕坐标转标准设备坐标
      // var x = (Sx / window.innerWidth) * 2 - 1; //标准设备横坐标
      // var y = -(Sy / window.innerHeight) * 2 + 1; //标准设备纵坐标
      // var standardVector = new THREE.Vector3(x, y, 0.5); //标准设备坐标

      // //标准设备坐标转世界坐标
      // var worldVector = standardVector.unproject(camera);

      //射线投射方向单位向量(worldVector坐标减相机位置坐标)
      // var ray = worldVector.sub(camera.position).normalize();
      //创建射线投射器对象
      // var raycaster = new THREE.Raycaster(camera.position, ray);
      //方法2
      let x = event.clientX;
      let y = event.clientY;
      let mouse = new THREE.Vector2();

      mouse.x = (x / window.innerWidth) * 2 - 1;
      mouse.y = -(y / window.innerHeight) * 2 + 1;

      var raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, camera)

      //返回射线选中的对象
      var intersects = raycaster.intersectObjects(Bplace); //Bplace为需要被点击的目标体池集合

      if (intersects.length > 0) {
        console.log('拾取到了');

        let obj = intersects[0].object;
        if (getGroup("video4", obj)) {

          let child = getGroup("video4", obj)
          renderDiv(child);
          child.traverse(function (obj) {
            if (obj.isMesh) {
              obj.material.color.set(0xff0000);
            }
          })
        } else if (getGroup("video3", obj)) {

          let child = getGroup("video3", obj)
          renderDiv(child);
          child.traverse(function (obj) {
            if (obj.isMesh) {
              obj.material.color.set(0xff0000);
            }
          })
        } else if (getGroup("video2", obj)) {

          let child = getGroup("video2", obj)
          renderDiv(child);
          child.traverse(function (obj) {
            if (obj.isMesh) {
              obj.material.color.set(0xff0000);
            }
          })
        } else if (getGroup("video1", obj)) {

          let child = getGroup("video1", obj)
          renderDiv(child);
          child.traverse(function (obj) {
            if (obj.isMesh) {
              obj.material.color.set(0xff0000);
            }
          })
        }

        // console.log(`hello ${name}`) 

        // let model;
        // for (let i = 0; i < scene.children.length; i++) {
        //   let child = scene.children[i];
        //   if (child.isGroup) {

        //     model = child.children[0];
        //     console.log(model)
        //     console.log(model.children[0])
        //   }
        // }

      }
    }
  </script>

</body>

</html>