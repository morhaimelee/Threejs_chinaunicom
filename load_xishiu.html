<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>习水酒厂</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      /* 隐藏body窗口区域滚动条 */
      /* background-image: linear-gradient(rgb(46,81,255), #000); */
    }

    /* #cc {
      background-image: linear-gradient(rgb(46,81,255), #000);
    } */
  </style>
  <!-- <link rel="stylesheet" href="./css/index.css" /> -->
  <script src="https://cdn.staticfile.org/jquery/3.5.0/jquery.min.js"></script>
  <!--引入three.js三维引擎-->
  <script src="./js/three.js"></script>
  <!-- 引入threejs扩展控件OrbitControls.js -->
  <script src="./js/OrbitControls.js"></script>
  <!-- 引入gltf -->
  <script src="./js/GLTFLoader.js"></script>
  <!-- obj -->
  <!-- <script src="./js/OBJLoader.js"></script>
  <script src="./js/MTLLoader.js"></script> -->
  <!-- fps查看 -->
  <script src="./js/stats.min.js"></script>
  <!--加载控制器-->
  <script src="./js/TrackballControls.js"></script>
  <!-- 2D渲染器 -->
  <script src="./js/CSS2DRenderer.js"></script>
  <!--加载缓动插件-->
  <!-- <script src="./js/TweenMax.min.js"></script> -->
</head>

<body onload="draw();">
    <canvas id="cc"></canvas>
  <script>
    let mixer = null
    let objAll = null
    let container, stats, controls

    let camera,
      scene,
      renderer,
      light,
      point,
      point3,
      directionalLight,
      ambient

    let model

    let Vplace1 = []
    let Vplace2 = []
    let width, height, k, s

    let GLTFLoader_AllBuild,
      GLTFLoader_otherBuild,
      GLTFLoader_First,
      GLTFLoader_Video2,
      GLTFLoader_Video3,
      GLTFLoader_Video4

    let model_floor1, model_floor2, model_floor3, model_floor4, model_floor5
    let model_video1, model_video2, model_video3, model_video4, model_video5

    let video_path = './assets/sexiangtou.gltf'
    let gate_path = './assets/zhaji_real.gltf'
    let smoke_path = './assets/yangan.gltf'
    let water_path = './assets/water_box.gltf'

    let model_all = [] //所有模型
    let model_all_floor1 = [] //每层所有模型
    let model_all_floor2 = []
    let model_all_floor3 = []
    let model_all_floor4 = []
    let model_all_floor5 = []
    let model_all_floor6 = []
    let model_all_floor7 = []
    let model_all_floor8 = []
    let model_all_floor9 = []
    let model_all_floorB1 = []
    //创建控件对象  相机对象camera作为参数   控件可以监听鼠标的变化，改变相机对象的属性
    // controls = new THREE.OrbitControls(camera, renderer.domElement);

    function initStats() {
      stats = new Stats()
      document.body.appendChild(stats.dom)
    }

    function init() {
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        canvas: document.querySelector('#cc'),
      })
      renderer.setPixelRatio(window.devicePixelRatio)
      renderer.setSize(window.innerWidth, window.innerHeight)
      renderer.shadowMap.enabled = true //渲染器接收阴影渲染

      renderer.setClearColor('rgb(0,47,94)', 1) //背景颜色像素及渲染
      // renderer.setClearColor('rgb(0,16,32)', 1)//进入楼层后更改

      // renderer.setClearColor('linear-gradient(rgb(46,81,255), #000)', 1.0);
      // renderer.setClearColor('rgba(135,206,250,0.5)',1.0);

      window.addEventListener('resize', onWindowResize, false) //窗口大小变化后，针对当前窗口大小比例渲染

      /**
       * 相机设置
       */
      width = window.innerWidth //窗口宽度
      height = window.innerHeight //窗口高度
      k = width / height //窗口宽
      // s = 300; //三维场景显示范围控制系数，系数越大，显示的范围越大
      s = 250
      //创建相机对象
      // camera = new THREE.OrthographicCamera(-s * k, s * k, s, -s, 1, 2000);
      camera = new THREE.PerspectiveCamera(45, width / height, 10, 10000)
      camera.position.set(150, 300, 500) //设置相机位置
      // camera.position.set(10, 30, 100) //设置相机位置
      // camera.position.set(1000, 1000, 2000); //设置相机位置
      // camera.position.z = 2000

      // //监听鼠标事件，触发渲染函数，更新canvas画布渲染效果
      controls = new THREE.OrbitControls(
        camera,
        document.querySelector('#cc'),
      ) //添加控制器 //设置控制器。方便操控3d世界。
      // controls.target.set(0, 0, 0); //设置控制器控制中心点
      // controls.update(); //控制器更新
      //设置相机距离原点的最远距离`````````
      controls.minDistance = 1
      //设置相机距离原点的最远距离
      controls.maxDistance = 2000

      scene = new THREE.Scene() //创建场景
      scene.name = 'WEB_Scene'
      // camera.lookAt(scene.position); //设置相机方向(指向的场景对象)

      //增加背景图
      //   var loader = new THREE.TextureLoader();
      //   var backgroundTexture = loader.load( './assets/background/background.png');
      //   scene.background = backgroundTexture;

      // 模拟坐标轴
      var axesHelper = new THREE.AxesHelper(100)
    //   scene.add(axesHelper)
      /**
       * 光源设置
       */
      //点光源
    //   point = new THREE.PointLight(0xffffff)
    //   point.position.set(0, 8.63, 55.19) //点光源中间门上
    //   scene.add(point) //点光源添加到场景中
    //   var point2 = new THREE.PointLight(0xffffff);
    //   point2.position.set(-180.418, 1500.135, -1900.433); //点光源左侧
    //   scene.add(point2); //点光源添加到场景中
      // point3 = new THREE.PointLight(0x72b1ff);
      // point3.position.set(463.018, 278.976, -21.585); //点光源右侧
      // scene.add(point3); //点光源添加到场景中
      // var point4 = new THREE.PointLight(0x72b1ff);
      // point4.position.set(136.340, 336.995, -438.744); //点光源后侧
      // scene.add(point4); //点光源添加到场景中
    //   var point5 = new THREE.PointLight(0xffffff);
    //   point5.position.set(500.809, 1585.392, -1510.896); //左圈
    //   scene.add(point5); //点光源添加到场景中

      //平行光
      directionalLight = new THREE.DirectionalLight(0xffffff, 2.5)
      directionalLight.position.set(5, 100, 157.199)
      scene.add(directionalLight)
      // 环境光
      // ambient = new THREE.AmbientLight(0x72b1ff);
      ambient = new THREE.AmbientLight(0xffffff)
      scene.add(ambient)


      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/地面.gltf', function (obj) {
          console.log(obj)
          obj.scene.children[0].traverse(function (obj) {
          if (obj.isMesh) {
            obj.material.color.set(0x000000)
            obj.material.emissive.set(0x001435)
          }
          })
          obj.scene.children[1].traverse(function (obj) {
          if (obj.isMesh) {
            obj.material.color.set(0x000000)
            obj.material.emissive.set(0x8EF1FF)
          }
        })
        //道路及大楼
        obj.scene.name = 'ground'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/广场.gltf', function (obj) {
        obj.scene.name = 'square'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/树.gltf', function (obj) {
        obj.scene.name = 'tree'
        scene.add(obj.scene)
      })
      
      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/1.gltf', function (obj) {
        obj.scene.name = 'build'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/2.gltf', function (obj) {
        obj.scene.name = 'build2'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/3.gltf', function (obj) {
        obj.scene.name = 'build3'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/4.gltf', function (obj) {
        obj.scene.name = 'build4'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/5.gltf', function (obj) {
        obj.scene.name = 'build5'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/6.gltf', function (obj) {
        obj.scene.name = 'build6'
        scene.add(obj.scene)
      })

      GLTFLoader_AllBuild = new THREE.GLTFLoader()
      GLTFLoader_AllBuild.load('./assets2/7.gltf', function (obj) {
        obj.scene.name = 'build7'
        scene.add(obj.scene)
      })

    }

    //隐藏模型
    function hiddenObject(obj) {
      let selectedObject = scene.getObjectByName(obj)
      console.log(selectedObject)
      selectedObject.visible = false
    }
    //显示模型
    function showObject(obj) {
      let selectedObject = scene.getObjectByName(obj)
      console.log(selectedObject)
      selectedObject.visible = true
    }
    //移除模型
    function removeEntity(object) {
      let selectedObject = scene.getObjectByName(object)
      scene.remove(selectedObject)
    }

    //遍历所有模型
    function modelTraverse() {
      for (let i = 0; i < scene.children.length; i++) {
        model_all.push(scene.children[i])
      }
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight //相机视锥体的长宽比
      camera.updateProjectionMatrix() //更新相机投影矩阵

      renderer.setSize(window.innerWidth, window.innerHeight) //渲染器大小
    }

    function draw() {
      init()
      animate()

    }

    // function world2Screen(x, y, z) {
    //   let worldVector = new THREE.Vector3(x, y, z);
    //   let vector = worldVector.project(camera);

    //   let halfWidth = window.innerWidth / 2;
    //   let halfHeight = window.innerHeight / 2;

    //   let result = {
    //     x: Math.round(vector.x * halfWidth + halfWidth),
    //     y: Math.round(-vector.y * halfHeight + halfHeight)
    //   };

    //   return result;
    // }
    // 更新div的位置
    // function renderDiv(object, intersect) {
    //   let {
    //     point: {
    //       x,
    //       y,
    //       z
    //     }
    //   } = intersect;
    //   let position = world2Screen(x, y, z);

    //   // let testIcon = createIcon(object.name)
    // createIcon(object.name).css({
    //   'left': position.x + (-20) + 'px',
    //   'top': position.y + (-55) + 'px'
    // })
    //   $(".testDiv").text(object.name).css({
    //     'left': position.x + 'px',
    //     'top': position.y + 25 + 'px'
    //   });
    // }


    function animate() {
      controls.update()
      renderer.render(scene, camera)
      requestAnimationFrame(animate)
    }

    function loadModel(path, gltf_name, floor_num, pst_x, pst_y, pst_z) {
      new THREE.GLTFLoader().load(path, function (gltf) {
        gltf.scene.name = gltf_name //set模型名字
        gltf.scene.position.set(pst_x, pst_y, pst_z) //set模型位置

        model_all_num['model_all_floor' + floor_num].push(gltf.scene.position) //添加模型所在楼层位置

        // model.position.set(0, 60, 0);
        // let sc = 3;
        model = gltf.scene.children[0]
        model.traverse(function (child) {
          //对模型体内的每个几何体进行遍历
          if (child.isMesh) {
            child.castShadow = true //允许模型本身对自己产生阴影
            child.receiveShadow = true //接受阴影渲染
            // child.scale.set(sc, sc, sc); //模型重置比例放大。

            Vplace1.push(child)
          }
        })

        scene.add(gltf.scene)
      })
    }


  </script>
</body>

</html>